worker_processes 1;

env HF_TOKEN;
env SPACE_USER;
env SPACE_NAME;

events {
  worker_connections 1024;
}

http {
  lua_shared_dict jwt_cache 10m;

  resolver 1.1.1.1 ipv6=off;

  map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
  }

  server {
    listen 8080;
    server_name _;

    location / {
      set $target_host "";

      access_by_lua_block {
        local cache = ngx.shared.jwt_cache
        local jwt = cache:get("spaces_jwt")

        if not jwt then
          local cjson = require("cjson.safe")

          local hf_token   = os.getenv("HF_TOKEN")
          local space_user = os.getenv("SPACE_USER")
          local space_name = os.getenv("SPACE_NAME")

          if not hf_token or not space_user or not space_name then
            ngx.exit(500)
          end

          local sock = ngx.socket.tcp()
          sock:settimeout(5000)

          local ok = sock:connect("huggingface.co", 443)
          if not ok then
            ngx.exit(502)
          end

          local ok = sock:sslhandshake(nil, "huggingface.co", false)
          if not ok then
            ngx.exit(502)
          end

          local path = "/api/spaces/" .. space_user .. "/" .. space_name .. "/jwt"

          local req =
            "GET " .. path .. " HTTP/1.1\r\n" ..
            "Host: huggingface.co\r\n" ..
            "Authorization: Bearer " .. hf_token .. "\r\n" ..
            "Accept: application/json\r\n" ..
            "Connection: close\r\n\r\n"

          sock:send(req)

          while true do
            local line = sock:receive("*l")
            if not line or line == "" then break end
          end

          local body = ""
          while true do
            local chunk = sock:receive(4096)
            if not chunk then break end
            body = body .. chunk
          end

          sock:close()

          local data = cjson.decode(body)
          if not data or not data.token then
            ngx.exit(502)
          end

          jwt = data.token
          cache:set("spaces_jwt", jwt, 86400)
        end

        local space_user = os.getenv("SPACE_USER")
        local space_name = os.getenv("SPACE_NAME")
        ngx.var.target_host = space_user .. "-" .. space_name .. ".hf.space"

        local incoming_cookie = ngx.var.http_cookie
        if incoming_cookie and incoming_cookie ~= "" then
          ngx.req.set_header("Cookie", incoming_cookie .. "; spaces-jwt=" .. jwt)
        else
          ngx.req.set_header("Cookie", "spaces-jwt=" .. jwt)
        end
      }

      proxy_pass https://$target_host;
      proxy_http_version 1.1;

      proxy_set_header Host $target_host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-Host $host;

      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_buffering off;
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
    }
  }
}
