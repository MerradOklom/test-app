worker_processes 1;

env HF_TOKEN;
env SPACE_USER;
env SPACE_NAME;

events {
  worker_connections 1024;
}

http {
  lua_shared_dict jwt_cache 10m;

  resolver 1.1.1.1 ipv6=off;

  map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
  }

  server {
    listen 8080;
    server_name _;

    location / {
      set $target_host "";
      set $base_path "";
      set $sub_href "";
      set $sub_src "";

      # Detect Render base path (/c/<id>/)
      if ($request_uri ~ "^(/c/[^/]+/)") {
        set $base_path $1;
      }

      access_by_lua_block {
        local cache = ngx.shared.jwt_cache

        -- JWT cache
        local jwt = cache:get("spaces_jwt")
        if not jwt then
          local handle = io.popen("/opt/get_jwt.sh")
          jwt = handle:read("*a")
          handle:close()

          if not jwt or jwt == "" then
            ngx.log(ngx.ERR, "Failed to fetch Space JWT")
            ngx.exit(500)
          end

          cache:set("spaces_jwt", jwt, 600)
        end

        -- Target HF host
        local space_user = os.getenv("SPACE_USER")
        local space_name = os.getenv("SPACE_NAME")

        if not space_user or not space_name then
          ngx.log(ngx.ERR, "Missing SPACE_USER or SPACE_NAME")
          ngx.exit(500)
        end

        ngx.var.target_host = space_user .. "-" .. space_name .. ".hf.space"

        -- Build sub_filter replacement strings
        local base_path = ngx.var.base_path or ""
        ngx.var.sub_href = 'href="' .. base_path
        ngx.var.sub_src  = 'src="'  .. base_path

        -- Inject HF auth
        ngx.req.set_header("Cookie", "spaces-jwt=" .. jwt)
      }

      proxy_pass https://$target_host;
      proxy_http_version 1.1;

      proxy_set_header Host $target_host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Prefix $base_path;

      # WebSockets
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      # Streaming
      proxy_buffering off;
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;

      # Safe HTML rewriting
      sub_filter_once off;
      sub_filter 'href="/' $sub_href;
      sub_filter 'src="/'  $sub_src;
    }
  }
}
